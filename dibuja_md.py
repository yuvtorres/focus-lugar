import sys
sys.path.insert(0, 'src/')
from funobjetivo import fun_objetivo
import research_tool
import geopandas as gpd
import contextily as ctx
import json
from geojson import Polygon, Feature, FeatureCollection
from mpl_toolkits.axes_grid1 import make_axes_locatable
from matplotlib import pyplot as plt

def dibuja():
    lat_max=40.521943
    lat_min=40.402217
    lng_max=-3.736493
    lng_min=-3.658524
    num_pasos=10
    paso_lat=(lat_max-lat_min)/num_pasos
    paso_lng=(lng_max-lng_min)/num_pasos

 
    valor_md= [[1576.502822786425, 1706.6024631007563, 1765.4756749258, 1730.4701125108154, 1676.7717989715075, 1773.888975699718, 1727.973873236178, 1818.7390118225294, 1778.3675195488888, 1636.4195734196987], [1617.990830299028, 1765.4574264030343, 2082.8787400397086, 1970.475127569303, 1880.4715724252405, 1808.9799799492425, 1749.4835753156208, 1865.676916691485, 1699.8442690306997, 1548.661404708652], [1800.4411737138187, 1899.0382807711433, 2135.728808486968, 2146.4674423175193, 2060.405058854577, 1857.6465020530975, 1830.4064166238215, 1718.8702757811516, 1545.4603192802192, 1552.44760033048], [1860.8659767078823, 2031.1509322836484, 1940.9909256212586, 2205.8917787800806, 2113.3416929714876, 1888.8082424298354, 1848.3404511802141, 1580.1835206839178, 1590.9000661859593, 1517.5458150832567], [2010.6467875229014, 2118.838771887762, 2100.4620470586665, 2170.607697158998, 2055.463328539102, 1894.602931961983, 1844.0016710111192, 1551.3091453608013, 1610.6799555186594, 1482.1423588430466], [2035.8840085213733, 2145.3105742056873, 1938.3521119766278, 2060.278987798437, 1951.5575632793266, 1900.7566749129032, 1665.8443026800874, 1539.317365639115, 1555.804831075347, 1265.444367025447], [1958.6557279825324, 2130.8823758158683, 2065.9273058216145, 2002.0850953883328, 1851.5665856314931, 1742.669397791948, 1726.0666330187992, 1505.875231162832, 1395.0684212318604, 1159.8286615433553], [1921.5252039954185, 2093.248368534183, 2031.135521245579, 1952.5024128287732, 1734.596183216546, 1659.3668957295552, 1638.4777732906803, 1451.9091595890104, 1201.37517688246, 1065.8097462167982], [1770.0217926477626, 1929.407113243848, 1923.3225808769876, 1799.5299623355581, 1688.3144743339237, 1571.1412517480169, 1365.7765001587277, 1342.1435768352987, 1142.198731863111, 896.5992603981927], [1355.1472758947357, 1598.5996571094881, 1722.815245369124, 1634.44264055553, 1670.1450864594226, 1503.8584139014665, 1228.490413775686, 1125.954091059637, 1179.4306413278232, 778.7172073157207]]
    print(valor_md)
    malla_md=[]
    for i in range(num_pasos):
        for k in range(num_pasos):
            el_cubo=Polygon([[(lng_min + ( float(i) - 0.5)*paso_lng, lat_min + (float(k)-0.5)*paso_lat),
                          (lng_min + ( float(i) + 0.5)*paso_lng, lat_min + (float(k)-0.5)*paso_lat),
                          (lng_min + ( float(i) + 0.5)*paso_lng, lat_min + (float(k)+0.5)*paso_lat),
                          (lng_min + ( float(i) - 0.5)*paso_lng, lat_min + (float(k)+0.5)*paso_lat),
                          (lng_min + ( float(i) - 0.5)*paso_lng, lat_min + (float(k)-0.5)*paso_lat)]])

            malla_md.append( Feature(properties={"valor":valor_md[k][i]},geometry=el_cubo) )

    malla_md_json= FeatureCollection(malla_md)
    print(malla_md) 
    with open('output/md_json.json', 'w') as outfile:
        json.dump(malla_md_json, outfile)

    df1=gpd.read_file('output/md_json.json')
    df1 = df1.to_crs(epsg=3857)

    fig,ax1=plt.subplots(1, 1)
    divider = make_axes_locatable(ax1)
    cax = divider.append_axes("right", size="5%", pad=0.1)
    ax1=df1.plot(column='valor', alpha=0.5, ax=ax1,legend=True, cax=cax)
    fig.set_size_inches(10.5, 15.5)
    ctx.add_basemap(ax1)
    plt.savefig('output/map_md.png')
